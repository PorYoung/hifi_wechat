<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="/static/css/console.css" rel="stylesheet">
    <link href="/static/css/font-awesome.min.css" rel="stylesheet">
    <link href="/static/plus/css/jquery.popuplayer.css" rel="stylesheet">
    <link href="/static/plus/css/cropbox.css" rel="stylesheet">
    <title>console</title>
    <script src="/static/js/jquery.js"></script>
    <script src="/static/js/myUtils.js"></script>
    <script src="/static/plus/js/jquery.popuplayer.js"></script>
    <script src="/static/plus/js/cropbox.js"></script>
    <script src="/static/js/myLoading.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .popup-layer-content{
            display: flex;
        }
        .cropboxCloseWrap{
            position: absolute;
            top: -50%;
            left: calc(50% - 30px);
            width: 60px;
            height: 60px;
            cursor: pointer;
        }
        .cropboxCloseWrap:hover .cropboxClose{
            animation-play-state: paused;
        }
        .cropboxCloseWrap > span{
            position: absolute;
            font-size: 20px;
            left: calc(50% - 20px);
            top: calc(50% - 15px);
            color: #eeeeee;
        }
        .cropboxClose{
            position: absolute;
            line-height: 60px;
            text-align: center;
            border-radius: 50%;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: #41ab6b;
            border: 30px solid #31b0d5;
            animation: cropboxCloseSpin ease-in 5s alternate infinite;
            transition: all 1s;
        }
        .cropboxClose::after,.cropboxClose::before{
            content: ' ';
            display: block;
            position: relative;
            width: 30px;
            height: 30px;
            left: -15px;
            border-radius: 50%;
            background: #31b0d5;
        }
        .cropboxClose::before{
            bottom: -5px;
        }
        .loadingBar{
            display: flex;
            justify-content: flex-end;
            flex-direction: column;
            align-items: center;
            background-color: rgba(38,38,38,.7);
            border-radius: 2em;
            width: 15px;
            padding: 1px;
            opacity: 0;
        }
        .loadingBar > i{
            background-color:#45e3cc;
            background-image: linear-gradient(45deg,rgba(255,255,255,.2) 25%,transparent 0,transparent 50%,rgba(255,255,255,.2) 0,rgba(255,255,255,.2) 75%,transparent 0);
            background-size: 100% 15px;
            width: 15px;
            border-radius: 2em; 
        }
        @keyframes cropboxCloseSpin{
            0%{
                transform: rotate(0);
                border-radius: 50%;
            }
            25%{
                border-radius: 40% 50% 25% 45%;
            }
            50%{
                border-radius: 40%;
            }
            75%{
                border-radius: 20% 35% 45% 40%;
            }
            100%{
                transform: rotate(365deg);
                border-radius: 45%; 
            }
        }
        @keyframes loadingBarMove{
            0%{
                background-position:0 0;
            }
            100%{
                background-position:0 -100%;
            }
        }
        .c-r-s-panel-guests-item-delete{
            position: absolute;
            right: -50%;
            top: 0;
            bottom: 0;
            width: 50%;
            color: red;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            transition: all .5s;
        }
        <% if(UI.background == "starsky") { %>
        #starsky{
        <% }else if(UI.background == "cloudsky"){ %>
        #cloudsky{
        <% }else if(UI.background == "romanticbubble"){ %>
        #romanticbubble{
        <% }else if(UI.background == "mid-autumn"){ %>
        #mid-autumn{
        <% }else{ %>
        #starfield{
        <% } %>
            box-shadow: 0px 0px 1px 0px green;
            border: 1px solid #1ece1e;
        }
    </style>
    <script>
        //初始化加载设置
        const config = {
            flags:{},
            guests: [],
            QRSrc:null,
            UI:{
                username: "<%= username %>",
                background: "<%= UI.background %>",
                avatar: "<%= UI.avatar %>",
                bgtext: "<%= UI.bgtext %>",
                bgtextContent: "<%= UI.bgtextContent %>"
            },
            messageData:[],
            connections:[]
        }
        $(function($){
            
            var IO = io('/allChat')
            $.get('/api/wall/flags?username=<%= username %>',function(data){
                if(!!data && data != '-1'){
                    Object.assign(config.flags,data)
                }
                console.log(config.flags.guests)
                if(!!config.flags.guests && config.flags.guests == '1'){
                    $('#c-r-s-guests').css({
                        'background-image':'linear-gradient(0,rgba(100,200,100,.5) 100%,transparent 0)'
                    })
                    $('#guests-flag').removeClass('fa-toggle-off').addClass('fa-toggle-on')
                }else{
                    $('#c-r-s-guests').css({
                        'background-image':'initial'
                    })
                    $('#guests-flag').removeClass('fa-toggle-on').addClass('fa-toggle-off')
                }
                if(!!config.flags.vote && config.flags.vote == '1'){
                    $('c-r-s-vote').css({
                        background:'rgba(100,205,100,.7)'
                    })
                }
            })
            $.get('/api/wall/guests?username=<%= username %>',function(data){
                if(data != '-1' && data instanceof Array) {
                    config.guests = data
                    data.forEach(function(item){
                        var html = `<div class = "c-r-s-panel-guests-item" data-guest-id="${item.guestId}"><img src="${item.avatarSrc}" title="${item.name}"><i class="fa fa-remove c-r-s-panel-guests-item-delete"></i></div>`
                        $('#c-r-s-panel-guests-list div:last-child').before(html).prev().on('click',showGuestInfo).on('mouseover',guestMouseOverEvent).on('mouseout',guestMouseOutEvent)
                    })
                }
            })
            $.get('/api/wall/QRSrc?username=<%= username %>',function(data){
                if(!!data && data != '-1' && data != '-2'){
                    $('#QRSrc').attr({
                        src:data
                    })
                }
            })
            $.get('/api/wall/votes?username=<%= username %>',function(data){
                if(!!data && data != '-1' && data instanceof Array){
                    var votes = data
                    votes.forEach(function(item){
                        var html = `
                            <div class="c-r-s-panel-vote-item" data-vote-id="${item.voteId}" data-save-flag="1">
                                <div class="c-r-s-panel-vote-item-header">
                                    <div><span>投票主题:</span><span>${item.title}</span></div>
                                    <div><i class="fa fa-check vote-save-btn"></i><i class="fa fa-remove vote-delete-btn"></i><i class="fa fa-toggle-off vote-switch-btn"></i></div>
                                </div>
                                <div class="c-r-s-panel-vote-item-info">
                                    <div class="c-r-s-panel-vote-item-settings">
                                        <p class="vote-check-btn" data-vote-flag="${item.settings.check}">`
                                            if(item.settings.check == '1'){
                                                html += `
                                                <span class="vote-radio-btn" style="flex:3;background-color:initial">单选</span>
                                                <span class="vote-options-btn" style="flex:7;background-color:rgba(30,200,30,.7)">多选</span>`
                                            }else{
                                                html += `
                                                <span class="vote-radio-btn">单选</span>
                                                <span class="vote-options-btn">多选</span>`
                                            }
                                        html += ` 
                                        </p>
                                        <p class="vote-type-btn" data-vote-flag="${item.settings.type}">`
                                            if(item.settings.type == '1'){
                                                html += `
                                                <span class="vote-text-image-btn" style="flex:3;background-color:initial">图文</span>
                                                <span class="vote-text-btn" style="flex:7;background-color:rgba(30,200,30,.7)">文字</span>`
                                            }else{
                                                html += `
                                                <span class="vote-text-image-btn">图文</span>
                                                <span class="vote-text-btn">文字</span>`
                                            }
                                        html += `
                                        </p>
                                        <p class="vote-display-btn" data-vote-flag="${item.settings.display}">`
                                            if(item.settings.display == '1'){
                                                html += `
                                                <span class="vote-show-illustration-btn" style="flex:3;background-color:initial">图表</span>
                                                <span class="vote-show-list-btn" style="flex:7;background-color:rgba(30,200,30,.7)">列表</span>`
                                            }else{
                                                html += `
                                                <span class="vote-show-illustration-btn">图表</span>
                                                <span class="vote-show-list-btn">列表</span>`                              
                                            }
                                        html += `
                                        </p>
                                    </div>
                                    <div class="c-r-s-panel-vote-item-options">
                                        <p>投票主题:<input name="voteTitle" value="${item.title}"></p>`
                                        var str = ''
                                        for(var i in item.options){
                                            str += `
                                                <p data-vote-options-id="${item.options[i].id}">
                                                    <span>选项${item.options[i].id}:</span>
                                                    <label class="vote-options-image" title="建议上传尺寸为100*100的图片" data-imgsrc="${item.options[i].imgsrc}">`
                                                        if(item.settings.type == '1'){
                                                            str += `<img src="${item.options[i].imgsrc}" alt="image" width="30px" height="30px" style="display:none;">`
                                                        }
                                                        else str += `<img src="${item.options[i].imgsrc}" alt="image" width="30px" height="30px">`
                                                        str += `
                                                        <input type="file" name="voteOptions${item.options[i].id}Image" style="display:none">
                                                    </label>
                                                    <input name="voteOption${i}Content" value="${item.options[i].content}">`
                                            if(parseInt(item.options[i].id) > 2){
                                                str += '<i class="fa fa-remove vote-options-delete"></i>'
                                            }
                                            str += '</p>'
                                        }
                                        str += '<p class="vote-options-addnew fa fa-plus"></p>'
                                    html += str + `
                                    </div>
                                </div>
                            </div>`
                        $('#c-r-s-panel-vote-addbtn').before(html)
                        $('.vote-options-addnew').off().on('click',optionsAddNew)
                        $('.c-r-s-panel-vote-item[data-vote-id="'+item.voteId+'"]').children('.c-r-s-panel-vote-item-header').on('click',voteShowInfo)
                        $('.c-r-s-panel-vote-item[data-vote-id="'+item.voteId+'"] input').change(function(){
                            $('.c-r-s-panel-vote-item[data-vote-id="'+item.voteId+'"]').attr({
                                "data-save-flag": "0"
                            })
                        })

                        var settingsItem = $('.c-r-s-panel-vote-item[data-vote-id="'+item.voteId+'"]').children('.c-r-s-panel-vote-item-info').children('.c-r-s-panel-vote-item-settings')
                        settingsItem.children('.vote-check-btn').children('.vote-radio-btn').on('click',{parent:'.vote-check-btn',ps:'next'},voteBtnClick)                    
                        settingsItem.children('.vote-check-btn').children('.vote-options-btn').on('click',{parent:'.vote-check-btn'},voteBtnClick)
                        settingsItem.children('.vote-type-btn').children('.vote-text-image-btn').on('click',{parent:'.vote-type-btn',ps:'next'},voteBtnClick)
                        settingsItem.children('.vote-type-btn').children('.vote-text-btn').on('click',{parent:'.vote-type-btn'},voteBtnClick)
                        settingsItem.children('.vote-display-btn').children('.vote-show-illustration-btn').on('click',{parent:'.vote-display-btn',ps:'next'},voteBtnClick)
                        settingsItem.children('.vote-display-btn').children('.vote-show-list-btn').on('click',{parent:'.vote-display-btn'},voteBtnClick)
                        $('.c-r-s-panel-vote-item[data-vote-id="'+item.voteId+'"]').children('.c-r-s-panel-vote-item-info').children('.c-r-s-panel-vote-item-options').children('p[data-vote-options-id]').children('.vote-options-image').children('input').on('change',chooseOptionsImage)
                        var headerBtn = $('.c-r-s-panel-vote-item[data-vote-id="'+item.voteId+'"]').children('.c-r-s-panel-vote-item-header').children('div').last()
                        headerBtn.children('.vote-save-btn').on('click',voteSave)
                        headerBtn.children('.vote-delete-btn').on('click',voteDelete)
                        headerBtn.children('.vote-switch-btn').on('click',voteSwitch)
                        $('.vote-options-delete').click(optionsDelete)
                    })
                }
            })
            $.get('/api/wall/activeVote?username=<%= username %>',function(data){
                if(!!data && data != '-1'){
                    $('[data-vote-id="'+data.voteId+'"]').attr({'data-open-flag':'1'}).children('.c-r-s-panel-vote-item-header').children('div').last().children('.vote-switch-btn').removeClass('fa-toggle-off').addClass('fa-toggle-on').css({
                        color: 'rgba(100,205,100,.7)'
                    })
                }
            })

            var showGuestInfo = function(){
                $('#c-r-s-panel-guests-list').removeClass('c-r-s-panel-guests-active')
                $('#c-r-s-panel-guests-addnew').addClass('c-r-s-panel-guests-active')
                var info = {}
                info.guestId = $(this).attr('data-guest-id')
                info.imgData = $(this).children('img').attr('src')
                if(!info.guestId) return
                var extraEventOnce = function(id,id_link,that){
                    that.settings.arr = []
                    guestsIconBackEvent.settings.activeMenu = []
                    that.settings.arr.push(['#c-r-s-panel-guests-panel-back','#c-r-s-panel-guests-list','',''])
                    that.iconHoverBind()
                    that.iconClickBind()
                    guestsIconBackEvent.settings.extraEvent = null
                    guestsIconBackEvent.settings.activeMenu = ['#c-r-s-panel-guests-panel-back','#c-r-s-panel-guests-list','','']
                }
                if(guestsIconBackEvent.settings.activeMenu[0] == '#c-r-s-panel-guests-panel-back'){
                    extraEventOnce('#c-r-s-panel-guests-panel-back','#c-r-s-panel-guests-list',guestsIconBackEvent)
                }
                guestsIconBackEvent.settings.activeMenu = ['#c-r-s-panel-guests-addbtn','#c-r-s-panel-guests-addnew','','']
                guestsIconBackEvent.settings.extraEvent = extraEventOnce
                config.guests.forEach(function(item){
                    if(item.guestId == info.guestId){
                        $('#c-r-s-panel-guests-addnew-guestName').val(item.name)
                        $('#c-r-s-panel-guests-addnew-guestTitle').val(item.title)
                        $('#c-r-s-panel-guests-addnew-guestIntroduction').val(item.introduction)
                        $('#c-r-s-panel-guests-addnew-avatar').attr({
                            'data-imgsrc': item.avatarSrc,
                            src: info.imgData,
                            'data-guest-id': item.guestId
                        })
                    }
                })
            }
            var deleteGuestInfo = function(evt){
                evt.stopPropagation()
                var info = {}
                info.guestId = $(this).parent().attr('data-guest-id')
                if(!info.guestId) return
                info.username = '<%= username %>'
                for(var i = 0;i < config.guests.length;i++){
                    if(config.guests[i].guestId == info.guestId){
                        info.avatarSrc = config.guests[i].avatarSrc
                        break
                    }
                }
                var html = "<i class='fa fa-check-circle-o fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Deletting...</span>"
                clearMyLoading = myLoading("Deletting...",html);
                $.post('/api/wall/deleteGuest',info,function(res){
                    if(res == '1'){
                        $('[data-guest-id="'+info.guestId+'"]').off().remove()
                        clearMyLoading()
                        html = "<i class='fa fa-check-circle-o fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Success</span>"
                        clearMyLoading = myLoading("Success",html)
                        //向大屏推送(-1 delete)
                        info.type = "-1"
                        IO.emit("guest",info)
                        setTimeout(function () {
                            clearMyLoading()
                        },1200)
                    }else{
                        clearMyLoading();
                        html = "<i class='fa fa-remove fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Failed</span>"
                        clearMyLoading = myLoading("Failed",html);
                        setTimeout(function () {
                            clearMyLoading();
                        },1200);
                    }
                })
            }
            var guestMouseOverEvent = function(){
                $(this).children('.c-r-s-panel-guests-item-delete').css({
                    right:0,
                    background:'rgba(203,203,203,.5)'
                }).on('click',deleteGuestInfo)
            }
            var guestMouseOutEvent = function(){
                $(this).children('.c-r-s-panel-guests-item-delete').css({
                    right:'-50%',
                    background:'initial'
                }).off()
            }
            const iconEventArr = [['#userInfo','#c-r-u','fa-user','fa-user-o'],
                ['#interface','#c-r-i','fa-object-ungroup','fa-object-group'],
                ['#setting','#c-r-s','fa-toggle-off','fa-toggle-on'],
                ['#data','#c-r-d','fa-bar-chart','fa-pie-chart'],
                ['#control','#c-r-c','fa-stethoscope','fa-wrench']
            ]
            const settingIconArr = [
                ['#c-r-s-guests','#c-r-s-panel-guests','fa-user-circle-o','fa-user-circle'],
                ['#c-r-s-vote','#c-r-s-panel-vote','fa-bar-chart','fa-line-chart'],
                ['#c-r-s-lottery','#c-r-s-panel-lottery','fa-gift','fa-smile-o'],
                ['#c-r-s-host','#c-r-s-panel-host','fa-user-circle-o','fa-user-circle'],
                // ['#c-r-s-sign','#c-r-s-panel-sign','fa-bar-chart','fa-line-chart'],
                // ['#c-r-s-video','#c-r-s-panel-video','fa-gift','fa-smile-o']
            ]
            var menuEvent = new iconEvent({
                idActiveClass: 'c-l-active',
                id_linkActiveClass: 'c-r-wrap-active',
                arr: iconEventArr
            }).iconClickBind().iconHoverBind()
            var addIconAnim = function (eleid,linkid) {
                $(eleid).parent().css({
                    'overflow-x':'hidden',
                    'position':'absolute',
                    padding:0
                }).animate({
                    opacity:'.7',
                    width:'70px',
                    right:'0'
                },1000).children().css({'font-size':'1em'})
            }
            var settingIconEvent = new iconEvent({
                arr: settingIconArr,
                idActiveClass: 'c-r-s-icon-active',
                id_linkActiveClass: 'c-r-s-panel-active',
                iconHoverBindInsertBool:false,
                extraEvent: addIconAnim
            }).iconClickBind().iconHoverBind()

            function switchFlag(e){
                var type = e.data.type
                var html = "<i class='fa fa-spinner fa-pulse fa-3x fa-fw'></i><span class='sr-only'>Saving...</span>"
                var clearMyLoading = myLoading("Saving...",html)
                var info = {
                    username: "<%= username %>",
                    flag: {}
                }
                if($(this).hasClass('fa-toggle-off')){
                    if(type == "guests"){
                        info.flag = {
                            guests: 1
                        }
                    }else if(type == "vote"){
                        info.flag = {
                            vote: 1
                        }
                    }else if(type == "lottery"){
                        info.flag = {
                            lottery: 1
                        }
                    }                           
                    $.post('/api/wall/flags',info,function(res){
                        if(!!res && res != '-1'){
                            if(type == "guests") {
                                config.flags.guests = 1
                                $('#guests-flag').removeClass('fa-toggle-off').addClass('fa-toggle-on')
                                $('#c-r-s-guests').css({
                                    'background-image':'linear-gradient(0,rgba(100,200,100,.5) 100%,transparent 0)'
                                })
                            }
                            else if(type == "vote") {
                                config.flags.vote = 1
                                $('#vote-flag').removeClass('fa-toggle-off').addClass('fa-toggle-on')
                                $('#c-r-s-vote').css({
                                    'background-image':'linear-gradient(0,rgba(100,200,100,.5) 100%,transparent 0)'
                                })
                            }
                            else if(type  == "lottery") {
                                config.flags.lottery = 1
                                $('#lottery-flag').removeClass('fa-toggle-off').addClass('fa-toggle-on')
                                $('#c-r-s-lottery').css({
                                    'background-image':'linear-gradient(0,rgba(100,200,100,.5) 100%,transparent 0)'
                                })
                            }
                            clearMyLoading();
                            html = "<i class='fa fa-check-circle-o fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Success</span>"
                            clearMyLoading = myLoading("Success",html);
                            setTimeout(function () {
                                clearMyLoading();
                            },1200); 
                        }
                    })
                }else{  
                    if(type == "guests"){
                        info.flag = {
                            guests: 0
                        }
                    }else if(type == "vote"){
                        info.flag = {
                            vote: 0
                        }
                    }else if(type == "lottery"){
                        info.flag = {
                            lottery: 0
                        }
                    }
                    $.post('/api/wall/flags',info,function(res){
                        if(!!res && res != '-1'){
                            if(type == "guests") {
                                config.flags.guests = 0
                                $('#guests-flag').removeClass('fa-toggle-on').addClass('fa-toggle-off')
                                $('#c-r-s-guests').css({
                                    'background-image':'initial'
                                })
                            }
                            else if(type == "vote") {
                                config.flags.vote = 0
                                $('#vote-flag').removeClass('fa-toggle-on').addClass('fa-toggle-off')
                                $('#c-r-s-vote').css({
                                    'background-image':'initial'
                                })
                            }
                            else if(type  == "lottery") {
                                config.flags.lottery = 0
                                $('#lottery-flag').removeClass('fa-toggle-on').addClass('fa-toggle-off')
                                $('#c-r-s-lottery').css({
                                    'background-image':'initial'
                                })
                            }
                            clearMyLoading();
                            html = "<i class='fa fa-check-circle-o fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Success</span>"
                            clearMyLoading = myLoading("Success",html);
                            setTimeout(function () {
                                clearMyLoading();
                            },1200); 
                        }
                    })
                }
            }
            
            $('#guests-flag').click({type:'guests'},switchFlag)
            $('#vote-flag').click({type:'vote'},switchFlag)
            $('#lottery-flag').click({type:'lottery'},switchFlag)

            //查看、修改、添加宾客界面返回事件
            var guestsIconBackArr = [
                ['#c-r-s-panel-guests-addbtn','#c-r-s-panel-guests-addnew','',''],
                ['#c-r-s-panel-guests-panel-back','#c-r-s-panel-guests-list','','']
            ]
            var guestsIconBackEvent = new iconEvent({
                arr:guestsIconBackArr,
                idActiveClass:'c-r-s-panel-guests-active',
                id_linkActiveClass:'c-r-s-panel-guests-active',
                iconHoverBindInsertBool:false,
                activeMenu:['#c-r-s-panel-guests-list','','',''],
                extraEventRemove:function(){
                    $('#c-r-s-panel-guests-addnew-guestName').val('')
                    $('#c-r-s-panel-guests-addnew-guestTitle').val('')
                    $('#c-r-s-panel-guests-addnew-guestIntroduction').val('')
                    $('#c-r-s-panel-guests-addnew-avatar').removeAttr('data-guest-id data-imgsrc').attr({
                        src:'/static/image/avatar_default.jpg'
                    })
                }
            }).iconHoverBind().iconClickBind()
            
            //头像修改
            var cropboxHTML = `<div class="cropboxCloseWrap"><i class="cropboxClose">--</i><span>完成</span></div>
                <div class="imageBox">
                    <div class="thumbBox"></div>
                    <div class="spinner" style="display: none">Loading...</div>
                </div>
                <div class="imageBoxPrev">
                    <div class="imageBoxAction"> 
                        <div class="new-contentarea tc"> 
                            <a href="javascript:void(0)" class="upload-img">
                                <label for="upload-avatar">选择图像</label>
                            </a>
                            <input type="file" class="" name="upload-avatar" id="upload-avatar" />
                        </div>
                        <input type="button" id="btnCrop"  class="Btnsty_peyton" value="裁切">
                        <input type="button" id="btnZoomIn" class="Btnsty_peyton" value="+"  >
                        <input type="button" id="btnZoomOut" class="Btnsty_peyton" value="-" >
                    </div>
                    <div class="cropped"></div>
                </div>
            </div>`
            
            $('#c-r-s-panel-guests-addnew-avatar').PopupLayer({
                content: cropboxHTML, // 内容，可以传入纯文本或类名或html
                target: "#c-r-s-panel-guests", // 把弹出层添加到的目标节点
                to: "top",   // 向哪个方向展开
                screenRatio: 0.5, // 占屏幕百分比
                blur: true, // 是否开启毛玻璃效果
                blurAreas: "#c-r-s-panel-guests-addnew",    //默认body > *
                color: "#000", // 文本颜色
                backgroundColor: "#eee", // 背景颜色
                contentToggle: false, // 点击content是否关闭弹出层
                closeBtn: '.cropboxCloseWrap',  // 指定关闭按钮
                // closeCallbackBefore: null,   //关闭前执行的函数
                // openCallback: null, // 展开的回调
                // closeCallback: null // 关闭的回调
            });
            var options ={
                thumbBox: '.thumbBox',
                spinner: '.spinner',
                imgSrc: '/static/image/1.jpg'
            }
            var avatarData = null
            var cropper = $('.imageBox').cropbox(options)
            $('#upload-avatar').on('change', function(){
                var reader = new FileReader()
                reader.onload = function(e) {
                    options.imgSrc = e.target.result
                    cropper = $('.imageBox').cropbox(options)
                }
                reader.readAsDataURL(this.files[0])
            })
            $('#btnCrop').on('click', function(){
                var img = cropper.getDataURL()
                avatarData = img
                $('.cropped').html('')
                $('.cropped').append('<img src="'+img+'" align="absmiddle" style="width:64px;margin-top:4px;border-radius:64px;box-shadow:0px 0px 12px #7E7E7E;" ><p>64px*64px</p>')
                $('.cropped').append('<img src="'+img+'" align="absmiddle" style="width:128px;margin-top:4px;border-radius:128px;box-shadow:0px 0px 12px #7E7E7E;"><p>128px*128px</p>')
                $('.cropped').append('<img src="'+img+'" align="absmiddle" style="width:180px;margin-top:4px;border-radius:180px;box-shadow:0px 0px 12px #7E7E7E;"><p>180px*180px</p>')
                $('#c-r-s-panel-guests-addnew-avatar').attr({
                    src:img
                })
                avatarData = cropper.getBlob(avatarData)
                // uploadAvatar(avatarData)
                // avatarData = null
            })
            $('#btnZoomIn').on('click', function(){
                cropper.zoomIn()
            })
            $('#btnZoomOut').on('click', function(){
                cropper.zoomOut()
            })  
            $('#c-r-s-panel-guests-panel-save').click(function(){
                var guestId = $('#c-r-s-panel-guests-addnew-avatar').attr('data-guest-id')
                if(!guestId) guestId = '<%= username %>' + new Date().getTime()
                var info = {
                    username: "<%= username %>",
                    guestId: guestId,   //username+创建日期时间戳，用于唯一标识用户
                    name: $('#c-r-s-panel-guests-addnew-guestName').val(),   //名称
                    title: $('#c-r-s-panel-guests-addnew-guestTitle').val(),  //头衔
                    introduction: $('#c-r-s-panel-guests-addnew-guestIntroduction').val(),    //介绍
                    // avatarSrc: $('#c-r-s-panel-guests-addnew-avatar').attr('src')     //头像地址
                    avatarSrc: $('#c-r-s-panel-guests-addnew-avatar').attr('data-imgsrc')   
                }
                var html = "<i class='fa fa-spinner fa-pulse fa-3x fa-fw'></i><span class='sr-only'>Loading...</span>"
                var clearMyLoading = myLoading("Saving...",html)
                var uploadAvatar = function(data){
                    if(!data) {
                        saveGuest(info)
                        return
                    }
                    var file = new FormData()
                    file.append('file',data)
                    $('#c-r-s-panel-guests-addnew-avatar').prev().css({
                        height: $('#c-r-s-panel-guests-addnew-avatar').height(),
                        opacity: '1'
                    }).children('i').css({
                        animation:'loadingBarMove 5s linear infinite'
                    })
                    var onprogress = function (evt){
                        var loaded = evt.loaded;     //已经上传大小情况 
                        var tot = evt.total;      //附件总大小 
                        var per = Math.floor(100*loaded/tot);  //已经上传的百分比 
                        $('#c-r-s-panel-guests-addnew-avatar').prev().children('i').css({
                            height: per+'%'
                        })
                    }
                    $.ajax({
                        url: '/api/wall/uploadAvatar?guestId='+info.guestId,
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        data: file,
                        xhr:function(){
                            var xhr = $.ajaxSettings.xhr();
                            if(onprogress && xhr.upload) {
                                xhr.upload.addEventListener("progress" , onprogress, false);
                                return xhr;
                            }
                        },
                        success:function(res){
                            if(res !== '-1'){
                                $('#c-r-s-panel-guests-addnew-avatar').attr({'data-imgsrc':res})
                                info.avatarSrc = res
                                $('#c-r-s-panel-guests-addnew-avatar').prev().animate({
                                    opacity:0
                                },1000).children('i').css({
                                    animation:'initial'
                                })
                                $('#c-r-s-panel-guests-addnew-avatar').prev().children('i').css({
                                    height: 0
                                })
                                avatarData = null
                                saveGuest(info)
                            }else{
                                $('#c-r-s-panel-guests-addnew-avatar').prev().animate({
                                    backgroundColor:'#d9534f'
                                },1000)
                                $('#c-r-s-panel-guests-addnew-avatar').attr({src:info.avatarSrc})
                                clearMyLoading()
                                html = "<i class='fa fa-remove fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Failed</span>"
                                clearMyLoading = myLoading("Upload Avatar Failed",html);
                                setTimeout(function () {
                                    clearMyLoading();
                                },1200);
                            }
                        }
                    })
                }
                var saveGuest = function(info){
                    $.post('/api/wall/guests',info,function(data){
                        if(!data || data == '-1'){
                            //保存失败
                            clearMyLoading();
                            html = "<i class='fa fa-remove fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Failed</span>"
                            clearMyLoading = myLoading("Failed",html);
                            setTimeout(function () {
                                clearMyLoading();
                            },1200);
                        }else{
                            //保存成功
                            $('#c-r-s-panel-guests-addnew-avatar').attr({'data-guest-id':info.guestId})
                            var flag = true
                            for(var i = 0;i < config.guests.length;i++){
                                if(config.guests[i].guestId == info.guestId){
                                    Object.assign(config.guests[i],info)
                                    $('[data-guest-id="'+info.guestId+'"]').children('img').attr({
                                        src:$('#c-r-s-panel-guests-addnew-avatar').attr('src'),
                                        title:config.guests[i].name
                                    })
                                    flag = false
                                    break
                                }
                            }
                            if(flag) {
                                config.guests.push(info)
                                var html = `<div class = "c-r-s-panel-guests-item" data-guest-id="${info.guestId}"><img src="${$('#c-r-s-panel-guests-addnew-avatar').attr('src')}" title="${$('#c-r-s-panel-guests-addnew-guestName').val()}""><i class="fa fa-remove c-r-s-panel-guests-item-delete"></i></div>`
                                $('#c-r-s-panel-guests-list div:last-child').before(html).prev().on('click',showGuestInfo).on('mouseover',guestMouseOverEvent).on('mouseout',guestMouseOutEvent)
                            }
                            clearMyLoading()
                            html = "<i class='fa fa-check-circle-o fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Success</span>"
                            clearMyLoading = myLoading("Success",html)
                            setTimeout(function () {
                                clearMyLoading()
                            },1200)
                            //向大屏推送(1 save)
                            info.type = "1"
                            IO.emit("guest",info)
                        }
                    })
                }
                uploadAvatar(avatarData)
            })

            //查看、修改活动
            $('#c-r-s-panel-vote-addbtn').on('click',voteAddNew)
            function optionsAddNew(){
                $(this).parents('.c-r-s-panel-vote-item').attr({'data-save-flag':'0'})
                var id = parseInt($(this).prev().attr('data-vote-options-id')) + 1
                var html = `
                <p data-vote-options-id="${id}">
                    <span>选项${id}:</span>
                    <label class="vote-options-image" title="建议上传尺寸为100*100的图片" data-imgsrc="/static/image/avatar_default.jpg">
                        <i class="fa fa-image"></i>
                        <input type="file" name="voteOptions${id}Image" style="display:none">
                    </label>
                    <input name="voteOption${id}Content">
                    <i class="fa fa-remove vote-options-delete"></i>
                </p>
                `
                $(this).before(html)
                $(this).prev().children('.vote-options-image').children('input').change(chooseOptionsImage)
                $(this).prev().children('.vote-options-delete').click(optionsDelete)
            }
            function optionsDelete(){
                $(this).parents('.c-r-s-panel-vote-item').attr({'data-save-flag':'0'})
                var arr = $(this).parent().nextAll('p[data-vote-options-id]')
                var id = parseInt($(this).parent().attr('data-vote-options-id'))
                var that = $(this).parent()
                for(var i = id;i < id + arr.length;i++){
                    that = that.next()
                    that.attr({
                        'data-vote-options-id': i
                    })
                    that.children('span').html('选项'+i)
                }
                $(this).parent().remove()
            }           
            function voteAddNew(){
                if($('.c-r-s-panel-vote-item-info').hasClass('c-r-s-panel-vote-item-info-active')){
                    var flag = Number.parseInt($('.c-r-s-panel-vote-item-info-active').parent('.c-r-s-panel-vote-item').attr('data-save-flag'))
                    if(!flag){
                        var f = confirm('有投票活动尚未保存，您确定离开吗?')
                        if(!f){
                            return
                        }
                    }
                }
                var id = new Date().getTime()
                var html = `
                <div class="c-r-s-panel-vote-item" data-vote-id="${id}">
                    <div class="c-r-s-panel-vote-item-header">
                        <div><span>投票主题:</span><span></span></div>
                        <div><i class="fa fa-check vote-save-btn"></i><i class="fa fa-remove vote-delete-btn"></i><i class="fa fa-toggle-off vote-switch-btn"></i></div>
                    </div>
                    <div class="c-r-s-panel-vote-item-info">
                        <div class="c-r-s-panel-vote-item-settings">
                            <p class="vote-check-btn" data-vote-flag="0">
                                <span class="vote-radio-btn">单选</span>
                                <span class="vote-options-btn">多选</span>
                            </p>
                            <p class="vote-type-btn" data-vote-flag="0">
                                <span class="vote-text-image-btn">图文</span>
                                <span class="vote-text-btn">文字</span>
                            </p>
                            <p class="vote-display-btn" data-vote-flag="0">
                                <span class="vote-show-illustration-btn">图表</span>
                                <span class="vote-show-list-btn">列表</span>                                
                            </p>
                        </div>
                        <div class="c-r-s-panel-vote-item-options">
                            <p>投票主题:<input name="voteTitle"></p>
                            <p data-vote-options-id="1">
                                <span>选项1:</span>
                                <label class="vote-options-image" title="建议上传尺寸为100*100的图片" data-imgsrc="/static/image/avatar_default.jpg">
                                    <i class="fa fa-image"></i>
                                    <input type="file" name="voteOptions1Image" style="display:none">
                                </label>
                                <input name="voteOption1Content">
                            </p>
                            <p data-vote-options-id="2">
                                <span>选项2:</span>
                                <label class="vote-options-image" title="建议上传尺寸为100*100的图片" data-imgsrc="/static/image/avatar_default.jpg">
                                    <i class="fa fa-image"></i>
                                    <input type="file" name="voteOptions2Image" style="display:none">
                                </label>
                                <input name="voteOption2Content">
                            </p>
                            <p class="vote-options-addnew fa fa-plus"></p>
                        </div>
                    </div>
                </div> 
                `
                $('.c-r-s-panel-vote-item-info-active').removeClass('c-r-s-panel-vote-item-info-active')
                $(this).before(html)
                $('.vote-options-addnew').off().on('click',optionsAddNew)
                $('.c-r-s-panel-vote-item[data-vote-id="'+id+'"]').children('.c-r-s-panel-vote-item-info').addClass('c-r-s-panel-vote-item-info-active')
                $('.c-r-s-panel-vote-item[data-vote-id="'+id+'"]').children('.c-r-s-panel-vote-item-header').on('click',voteShowInfo)
                $('.c-r-s-panel-vote-item[data-vote-id="'+id+'"] input').change(function(){
                    $('.c-r-s-panel-vote-item[data-vote-id="'+id+'"]').attr({
                        "data-save-flag": "0"
                    })
                })

                var settingsItem = $('.c-r-s-panel-vote-item[data-vote-id="'+id+'"]').children('.c-r-s-panel-vote-item-info').children('.c-r-s-panel-vote-item-settings')
                settingsItem.children('.vote-check-btn').children('.vote-radio-btn').on('click',{parent:'.vote-check-btn',ps:'next'},voteBtnClick)
                settingsItem.children('.vote-check-btn').children('.vote-options-btn').on('click',{parent:'.vote-check-btn'},voteBtnClick)
                settingsItem.children('.vote-type-btn').children('.vote-text-image-btn').on('click',{parent:'.vote-type-btn',ps:'next'},voteBtnClick)
                settingsItem.children('.vote-type-btn').children('.vote-text-btn').on('click',{parent:'.vote-type-btn'},voteBtnClick)
                settingsItem.children('.vote-display-btn').children('.vote-show-illustration-btn').on('click',{parent:'.vote-display-btn',ps:'next'},voteBtnClick)
                settingsItem.children('.vote-display-btn').children('.vote-show-list-btn').on('click',{parent:'.vote-display-btn'},voteBtnClick)
                $('.c-r-s-panel-vote-item[data-vote-id="'+id+'"]').children('.c-r-s-panel-vote-item-info').children('.c-r-s-panel-vote-item-options').children('p[data-vote-options-id]').children('.vote-options-image').children('input').on('change',chooseOptionsImage)
                var headerBtn = $('.c-r-s-panel-vote-item[data-vote-id="'+id+'"]').children('.c-r-s-panel-vote-item-header').children('div').last()
                headerBtn.children('.vote-save-btn').on('click',voteSave)
                headerBtn.children('.vote-delete-btn').on('click',voteDelete)
                headerBtn.children('.vote-switch-btn').on('click',voteSwitch)
            }
            function voteShowInfo(){
                if($('.c-r-s-panel-vote-item-info').hasClass('c-r-s-panel-vote-item-info-active')){
                    var flag = Number.parseInt($('.c-r-s-panel-vote-item-info-active').parent('.c-r-s-panel-vote-item').attr('data-save-flag'))
                    if(!flag){
                        var f = confirm('有投票活动尚未保存，您确定离开吗?')
                        if(!f){
                            return
                        }
                    }
                }
                if($(this).next('.c-r-s-panel-vote-item-info').hasClass('c-r-s-panel-vote-item-info-active')){
                    $('.c-r-s-panel-vote-item-info-active').removeClass('c-r-s-panel-vote-item-info-active')
                }else{
                    $('.c-r-s-panel-vote-item-info').removeClass('c-r-s-panel-vote-item-info-active')
                    $(this).next('.c-r-s-panel-vote-item-info').addClass('c-r-s-panel-vote-item-info-active')
                }
            }
            function voteSave(e){
                e.stopPropagation()
                var voteItem = $(this).parents('.c-r-s-panel-vote-item')
                if(voteItem.attr('data-save-flag') == '1') return
                if(voteItem.attr('data-open-flag') == '1') {
                    alert("该投票正在进行，请先关闭后修改")
                    return
                }
                var settingsItem = voteItem.children('.c-r-s-panel-vote-item-info').children('.c-r-s-panel-vote-item-settings')
                var optionsItem = voteItem.children('.c-r-s-panel-vote-item-info').children('.c-r-s-panel-vote-item-options')
                var voteId = voteItem.attr('data-vote-id')
                var vote = {}
                var options = []
                var settings = {}
                vote.voteId = voteId
                vote.title = optionsItem.children('p:eq(0)').children('input').val()
                if(!vote.title){
                    alert('投票主题不能为空哦')
                    return
                }
                //0：单选(default)，文字投票，列表显示    1:多选，图文投票(default)，动画显示(default)
                settings.check = settingsItem.children('.vote-check-btn').attr('data-vote-flag')
                settings.type = settingsItem.children('.vote-type-btn').attr('data-vote-flag')
                settings.display = settingsItem.children('.vote-display-btn').attr('data-vote-flag')
                for(var i = 1;i < optionsItem.children('p[data-vote-options-id]').length + 1;i++){
                    var item = optionsItem.children('p[data-vote-options-id="'+ i +'"]')
                    var obj = {}
                    obj.id = item.attr('data-vote-options-id')
                    obj.content = item.children('input').val()
                    if(!obj.content){
                        alert('选项内容不能为空')
                        return
                    }
                    obj.imgsrc = item.children('.vote-options-image').attr('data-imgsrc')
                    options.push(obj)
                }
                vote.settings = settings
                vote.options = options
                vote.username = "<%= username %>"
                //向服务器post数据
                var html = "<i class='fa fa-spinner fa-pulse fa-3x fa-fw'></i><span class='sr-only'>Loading...</span>"
                var clearMyLoading = myLoading("Saving...",html)
                $.post('/api/wall/votes',vote,function(res){
                    if(!!res && res != '-1'){
                        voteItem.attr({
                            'data-save-flag':'1'
                        })
                        voteItem.children(".c-r-s-panel-vote-item-header").children("div:first-child").children("span:last-child").html(vote.title)
                        clearMyLoading();
                        html = "<i class='fa fa-check-circle-o fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Success</span>"
                        clearMyLoading = myLoading("Success",html);
                        setTimeout(function () {
                            clearMyLoading();
                        },1200); 
                    }else{
                        voteItem.attr({
                            'data-save-flag':'0'
                        })
                        clearMyLoading();
                        html = "<i class='fa fa-remove fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Failed</span>"
                        clearMyLoading = myLoading("Failed",html);
                        setTimeout(function () {
                            clearMyLoading();
                        },1200);
                    }
                })
            }
            function voteDelete(e){
                e.stopPropagation()
                var flag = confirm('确定要删除该投票活动吗?')
                if(!flag) return
                var voteItem = $(this).parents('.c-r-s-panel-vote-item')
                var vote = {}
                vote.voteId = voteItem.attr('data-vote-id')
                vote.username = "<%= username %>"
                //向服务器发送删除请求
                var html = "<i class='fa fa-spinner fa-pulse fa-3x fa-fw'></i><span class='sr-only'>Loading...</span>"
                var clearMyLoading = myLoading("Deleting...",html)
                $.post('/api/wall/deleteVote',vote,function(res){
                    if(!!res && res != '-1'){
                        clearMyLoading();
                        html = "<i class='fa fa-check-circle-o fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Success</span>"
                        clearMyLoading = myLoading("Success",html);
                        setTimeout(function () {
                            clearMyLoading();
                        },1200); 
                        voteItem.remove()
                    }else{
                        clearMyLoading();
                        html = "<i class='fa fa-remove fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Failed</span>"
                        clearMyLoading = myLoading("Failed",html);
                        setTimeout(function () {
                            clearMyLoading();
                        },1200);
                    }
                })
            }
            function voteSwitch(e){
                e.stopPropagation()
                var voteItem = $(this).parents('.c-r-s-panel-vote-item')
                var vote = {}
                vote.voteId = voteItem.attr('data-vote-id')
                vote.username = "<%= username %>"        
                if($(this).hasClass('fa-toggle-off')){
                    var flag = confirm('确定在主屏幕上开启该投票活动吗')
                    if(!flag) return
                    var html = "<i class='fa fa-spinner fa-pulse fa-3x fa-fw'></i><span class='sr-only'>Loading...</span>"
                    var clearMyLoading = myLoading("Switching...",html)
                    vote.type = '1'
                    var that = $(this)
                    $.post('/api/wall/switchVote',vote,function(res){
                        if(!!res && res != '-1'){
                            clearMyLoading();
                            html = "<i class='fa fa-check-circle-o fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Success</span>"
                            clearMyLoading = myLoading("Success",html);
                            setTimeout(function () {
                                clearMyLoading();
                            },1200); 
                            $('.vote-open-btn').removeClass('fa-toggle-on').addClass('fa-toggle-off')
                            $('.c-r-s-panel-vote-item[data-open-flag="1"]').removeAttr('data-open-flag')
                            voteItem.attr({
                                'data-open-flag':'1'
                            })
                            that.removeClass('fa-toggle-off').addClass('fa-toggle-on').css({
                                color: 'rgba(100,205,100,.7)'
                            })
                            IO.emit("switchVote",vote)
                        }else{
                            clearMyLoading();
                            html = "<i class='fa fa-remove fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Failed</span>"
                            clearMyLoading = myLoading("Failed",html);
                            setTimeout(function () {
                                clearMyLoading();
                            },1200);
                        }
                    })
                }else{
                    var flag = confirm('确定在主屏幕上关闭该投票活动吗(关闭后修改活动内容原投票结果将被清空)')
                    if(!flag) return
                    var html = "<i class='fa fa-spinner fa-pulse fa-3x fa-fw'></i><span class='sr-only'>Loading...</span>"
                    var clearMyLoading = myLoading("Switching...",html)
                    vote.type = '0'
                    var that = $(this)
                    $.post('/api/wall/switchVote',vote,function(res){
                        if(!!res && res != '-1'){
                            clearMyLoading();
                            html = "<i class='fa fa-check-circle-o fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Success</span>"
                            clearMyLoading = myLoading("Success",html);
                            setTimeout(function () {
                                clearMyLoading();
                            },1200); 
                            voteItem.attr({
                                'data-open-flag':'0'
                            })
                            that.removeClass('fa-toggle-on').addClass('fa-toggle-off').css({
                                color: "#000"
                            })
                            IO.emit("switchVote",vote)
                        }else{
                            clearMyLoading();
                            html = "<i class='fa fa-remove fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Failed</span>"
                            clearMyLoading = myLoading("Failed",html);
                            setTimeout(function () {
                                clearMyLoading();
                            },1200);
                        }
                    })
                }
            }
            function voteBtnClick(event){
                parent = event.data.parent
                ps = event.data.ps || ''
                var flag = Number.parseInt($(this).parent(parent).attr('data-vote-flag'))
                if(!flag && !!$(this).next().html() || !!flag && !!$(this).prev().html()) return
                
                if($(this).hasClass('vote-text-image-btn')){
                    $(this).parents('.c-r-s-panel-vote-item-info').children('.c-r-s-panel-vote-item-options').children('p[data-vote-options-id]').children('.vote-options-image').show(200)
                }else if($(this).hasClass('vote-text-btn')){
                    $(this).parents('.c-r-s-panel-vote-item-info').children('.c-r-s-panel-vote-item-options').children('p[data-vote-options-id]').children('.vote-options-image').hide(200)                    
                }
                
                $(this).css({
                    flex:'7',
                    'background-color':'rgba(30,200,30,.7)'
                })
                if(ps == 'next'){
                    $(this).next().css({
                        flex:'3',
                        'background-color':'initial'
                    })
                    $(this).parent(parent).attr({
                       'data-vote-flag':'0'
                    })
                }else{
                    $(this).prev().css({
                        flex:'3',
                        'background-color':'initial'
                    })
                    $(this).parent(parent).attr({
                        'data-vote-flag':'1'
                    })
                }
                $(this).parents('.c-r-s-panel-vote-item').attr({
                    'data-save-flag': '0'
                })
            }
            function chooseOptionsImage(){
                var that = $(this)
                var reader = new FileReader()
                reader.onload = function(e) {
                    var image = new Image()
                    image.src = e.target.result
                    image.onload = function(){
                        var dataUrl = imageHandle.getDataURL(100,100,image)
                        that.prev().remove()
                        that.before('<img src="'+dataUrl+'" width="30px" height="30px" >')
                        var blob = imageHandle.getBlob(dataUrl)
                        var voteId = that.parents('.c-r-s-panel-vote-item').attr('data-vote-id')
                        var optionsId = voteId + '_' + that.parent().parent('p').attr('data-vote-options-id')
                        var uploadImage = function(data){
                            if(!data) return
                            var file = new FormData()
                            file.append('file',blob)
                            var onprogress = function (evt){
                                var loaded = evt.loaded;     //已经上传大小情况 
                                var tot = evt.total;      //附件总大小 
                                var per = Math.floor(100*loaded/tot);  //已经上传的百分比 
                                that.parent().after('<i style="transition:all .5s;width:10px;height:0;align-self:flex-end;background:rgba(20,200,20,.3)"></i>')
                                that.parent().next('i').css({
                                    height: Math.floor(per/100*35)
                                })
                            }
                            $.ajax({
                                url: '/api/wall/optionsImage?optionsId='+optionsId,
                                type: 'POST',
                                contentType: false,
                                processData: false,
                                data: file,
                                xhr:function(){
                                    var xhr = $.ajaxSettings.xhr();
                                    if(onprogress && xhr.upload) {
                                        xhr.upload.addEventListener("progress" , onprogress, false);
                                        return xhr;
                                    }
                                },
                                success:function(res){
                                    if(!res || res == '-1'){
                                        that.prev('img').parent().attr({
                                            'data-imgSrc':'/static/image/avatar_default.jpg'
                                        })
                                        that.parent().next('i').remove()
                                    }else{
                                        that.parent().next('i').remove()
                                        that.prev('img').parent().attr({
                                            'data-imgSrc':res
                                        })
                                    }
                                }
                            })
                        }
                        uploadImage(blob)
                    }
                }
                reader.readAsDataURL(this.files[0])
            }

            $("#setting-avatar span:nth-child(1)").click(function(){
                if($("#setting-avatar").attr("data-setting-avatar") == "rectangle"){
                    return
                }else{
                    $(this).css({
                        'background-color':'rgba(30,200,30,.7)'
                    })
                    $("#setting-avatar span:nth-child(2)").css({
                        'background-color':'initial'
                    })
                    $("#setting-avatar").attr({
                        "data-setting-avatar": "rectangle"
                    })
                }
            })
            $("#setting-avatar span:nth-child(2)").click(function(){
                if($("#setting-avatar").attr("data-setting-avatar") == "circle"){
                    return
                }else{
                    $(this).css({
                        'background-color':'rgba(30,200,30,.7)'
                    })
                    $("#setting-avatar span:nth-child(1)").css({
                        'background-color':'initial'
                    })
                    $("#setting-avatar").attr({
                        "data-setting-avatar": "circle"
                    })
                }
            })
            $("#setting-bgtext span:nth-child(1)").click(function(){
                if($("#setting-bgtext").attr("data-setting-bgtext") == "1"){
                    return
                }else{
                    $(this).css({
                        'background-color':'rgba(30,200,30,.7)'
                    })
                    $("#setting-bgtext span:nth-child(2)").css({
                        'background-color':'initial'
                    })
                    $("#bgtext-input").css({
                        display: "flex"
                    })
                    $("#setting-bgtext").attr({
                        "data-setting-bgtext": "1"
                    })
                }
            })
            $("#setting-bgtext span:nth-child(2)").click(function(){
                if($("#setting-bgtext").attr("data-setting-bgtext") == "0"){
                    return
                }else{
                    $(this).css({
                        flex:'7',
                        'background-color':'rgba(30,200,30,.7)'
                    })
                    $("#setting-bgtext span:nth-child(1)").css({
                        flex:'3',
                        'background-color':'initial'
                    })
                    $("#bgtext-input").css({
                        display: "none"
                    })
                    $("#setting-bgtext").attr({
                        "data-setting-bgtext": "0"
                    })
                }
            })
            $("#background-setting").children("div").click(function(){
                var id = $("#background-setting").attr("data-background-setting")
                if($(this).attr("id") == id) return
                $("#"+id).css({
                    border: "none",
                    "box-shadow": "initial"
                })
                $(this).css({
                    border: "1px solid #1ece1e",
                    "box-shadow": "0px 0px 1px green"
                })
                $("#background-setting").attr({
                    "data-background-setting": $(this).attr("id")
                })
            })
            //保存界面设计
            $("#settings-save span").click(function(){
                var info = {
                    background : $("#background-setting").attr("data-background-setting"),
                    avatar : $("#setting-avatar").attr("data-setting-avatar"),
                    bgtext : $("#setting-bgtext").attr("data-setting-bgtext"),
                    bgtextContent : $("#bgtext-input").children("input").val()
                }
                Object.assign(config.UI,info)
                var html = "<i class='fa fa-spinner fa-pulse fa-3x fa-fw'></i><span class='sr-only'>Loading...</span>"
                var clearMyLoading = myLoading("Saving...",html)
                $.post('/api/wall/setUI',config.UI,function(res){
                    if(!res || res == "-1"){
                        clearMyLoading();
                        html = "<i class='fa fa-remove fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Failed</span>"
                        clearMyLoading = myLoading("Failed, try again",html);
                        setTimeout(function () {
                            clearMyLoading();
                        },1200);
                    }else{
                        clearMyLoading()
                        html = "<i class='fa fa-check-circle-o fa-4x fa-fw' style='color: #00EE00'></i><span class='sr-only'>Success</span>"
                        clearMyLoading = myLoading("Success",html)
                        setTimeout(function () {
                            clearMyLoading()
                        },1200)
                    }
                })
            })

            //发送广播通知
            $("#c-r-s-panel-host-input").children('input').keyup(function (e) {
                if(e && e.keyCode == '13'){
                    var msg = {}
                    msg.from = "<%= username %>"
                    msg.content = $(this).val()
                    msg.loopTimes = parseInt($("#c-r-s-panel-host-input-number").children('input').val())
                    IO.emit("host",msg)
                    $(this).val('')
                    $("#c-r-s-panel-host-input-number").children('input').val('2')
                }
            })

            //初始化拉取连接用户信息
            $.get('/api/wall/connections?username=<%= username %>',function(data){
                data.forEach(function(item){
                    if(!item.times){
                        return item.times = 0
                    }
                })
                config.connections = data
                config.connections.sort(function(a,b){
                    return parseInt(b.times) - parseInt(a.times)
                })
            })

            //初始化拉取数据
            var page = 0
            function initGetMessage(){
                if(!page) page = 0
                page = parseInt(page)
                $.get("/api/allChat/getMessage", {
                    "page": page,
                    "origin": window.location.href
                }, function(data){
                    if(data == "-1" || data.length <= 0){
                        console.log('[初始化数据:数据库为空]')
                    }else{
                        var length = config.messageData.length
                        data.forEach(function(item){
                            item.content = item.content.replace(/\<div\>.+\<\/div\>/,"😁")
                            item.content = item.content.replace(/\<div\>/g,"😏")
                            item.content = item.content.replace(/\<\/div\>/g,"😏")
                            item.content = item.content.replace(/\<br\>/g,"😏")
                            item.content = item.content.replace(/\<p\>/g,"😏")
                            item.content = item.content.replace(/\<\/p\>/g,"😏")
                            config.messageData.push(item)
                            console.info("[新数据入库]")
                        })
                        if(config.messageData.length <= 10 && page >= 2 && page <= 5){
                            return initGetMessage(++page)
                        }
                        if(++page <= 3){
                            return initGetMessage()
                        }
                        config.messageData.forEach(function(msg){
                            var html = `<p data-openid="${msg.openid}"><span>${msg.from}:</span>`
                            if(!!msg.MsgType&&msg.MsgType=="image"){
                                html += `<img src="${msg.mediaId}"></p>`
                            }else{
                                html += `<span>${msg.content}</span></p>`
                            }
                            $("#c-r-d-message").append(html)
                        })
                        $("#c-r-d-message").children("header").html(config.messageData.length)
                        $("#c-r-d-message").children("p").children("img").mouseenter(function(){
                            var src = $(this).attr("src")
                            $("#c-r-d-show-panel").html('<img src="'+ src +'">').show()
                        }).mouseleave(function(){
                            $("#c-r-d-show-panel").hide()
                        })
                        $("#c-r-d-message").children("p").click(function(e){
                            e.stopPropagation()
                            var openid = $(this).attr("data-openid"),
                                info = null
                            for(var i = 0;i < config.connections.length;i++){
                                if(config.connections[i].openid == openid){
                                    info = config.connections[i]
                                    break;
                                }
                            }
                            var html = null
                            if(!!info){
                                html = `
                                <p><img src = "${info.headimgurl}"></p>
                                <p><span>名称</span><span>${info.nickname}</span></p>
                                <p><span>性别</span><span>${info.sex == "1"?"male":"female"}</span></p>
                                <p><span>省份</span><span>${info.province}</span></p>
                                <p><span>互动</span><span>${info.times}</span>
                                <p><span id="c-r-d-delete">删除该条消息</span><span id="c-r-d-shield">屏蔽此人</span></p>
                                `
                            }else{
                                html="<p>信息或用户不存在</p>"
                            }
                            $("#c-r-d-show-info").html(html).css({
                                transition:"right 1s",
                                right:"0"
                            }).attr({
                                "data-open-flag":"1"
                            })
                        })
                    }
                })
            }
            initGetMessage()
            $('body').on({
                'click':function(e){
                    var target = e.target;
                    if(target != $("#c-r-d-show-info")[0] && $("#c-r-d-show-info").attr("data-open-flag") != "0"){
                        $("#c-r-d-show-info").css({
                            right:"-55%"
                        }).attr({"data-open-flag":"0"})
                    }
                }
            })

            IO.on("public_message",function(msg){
                msg.content = msg.content.replace(/\<div\>.+\<\/div\>/,"😁")
                msg.content = msg.content.replace(/\<div\>/g,"😏")
                msg.content = msg.content.replace(/\<\/div\>/g,"😏")
                msg.content = msg.content.replace(/\<br\>/g,"😏")
                msg.content = msg.content.replace(/\<p\>/g,"😏")
                msg.content = msg.content.replace(/\<\/p\>/g,"😏")
                config.messageData.push(msg)
                console.info("[新数据入库]")
                var html = `<p data-openid="${msg.openid}"><span>${msg.from}:</span>`
                if(!!msg.MsgType&&msg.MsgType=="image"){
                    html += `<img src="${msg.mediaId}"></p>`
                }else{
                    html += `<span>${msg.content}</span></p>`
                }
                $("#c-r-d-message").append(html)
                $("#c-r-d-message").children("p:last-child").children("img").mouseenter(function(){
                    var src = $(this).attr("src")
                    $("#c-r-d-show-panel").html('<img src="'+ src +'">').show()
                }).mouseleave(function(){
                    $("#c-r-d-show-panel").hide()
                })
                $("#c-r-d-message").children("p:last-child").click(function(e){
                            e.stopPropagation()
                            var openid = $(this).attr("data-openid"),
                                info = null
                            for(var i = 0;i < config.connections.length;i++){
                                if(config.connections[i].openid == openid){
                                    info = config.connections[i]
                                    break;
                                }
                            }
                            var html = null
                            if(!!info){
                                html = `
                                <p><img src = "${info.headimgurl}"></p>
                                <p><span>名称</span><span>${info.nickname}</span></p>
                                <p><span>性别</span><span>${info.sex == "1"?"male":"female"}</span></p>
                                <p><span>省份</span><span>${info.province}</span></p>
                                <p><span>互动</span><span>${info.times}</span>
                                <p><span id="c-r-d-delete">删除该条消息</span><span id="c-r-d-shield">屏蔽此人</span></p>
                                `
                            }else{
                                html="<p>信息或用户不存在</p>"
                            }
                            $("#c-r-d-show-info").html(html).css({
                                transition:"right 1s",
                                right:"0"
                            }).attr({
                                "data-open-flag":"1"
                            })
                        })
            })
        })
    </script>
</head>
<body>
<div class="container">
    <div class="c-l">
        <header class="c-l-tile">
            <img src="/static/image/logo.svg" style="padding:20px;">
            <br>
            <span>welcome <%= username %> to HI-FI</span>
            <br>
            <a href="./wall/screen" style="color: #eeeeee;border-radius: 1em;background: #31b0d5;text-decoration: none;padding: 2px 5px;display: block;width: 40px;margin: 5px auto">启动</a>
            <div></div>
        </header>
        <div id="userInfo">
            <span>
                UserInfo<i class="fa fa-user" aria-hidden="true"></i>
            </span>
        </div>
        <div id="interface">
            <span>
                界面设计<i class="fa fa-object-ungroup" aria-hidden="true"></i>
            </span>
        </div>
        <div id="setting">
            <span>
                功能选择<i class="fa fa-toggle-off" aria-hidden="true"></i>
            </span>
        </div>
        <div id="data">
            <span>
                活动数据<i class="fa fa-bar-chart" aria-hidden="true"></i>
            </span>
        </div>
        <div id="control">
            <span>
            活动监控<i class="fa fa-stethoscope" aria-hidden="true"></i>
            </span>
        </div>
    </div>
    <div class="c-r">
        <div class="c-r-wrap">
            <div id="c-r-u">
                <header><i class="fa fa-cog fa-spin"></i>用户信息</header>
                <div>
                    <header>
                        <img src="/static/image/u_logo.ico" id="QRSrc">
                        <p>LOGO</p>
                    </header>
                    <div>
                        <p><span>username:</span><span><%= username %></span></p>
                        <p><span>other information:</span><span>Hi</span></p>
                        <p><span>other information:</span><span>Hello</span></p>
                        <p><span>other information:</span><span>yeah!</span></p>
                        <p><span>shortcut:</span></p>
                    </div>
                </div>
            </div>
            <div id="c-r-i">
                <div id="settings-btn">
                    <p id="setting-avatar" data-setting-avatar="<%= UI.avatar %>">头像:
                    <% if(UI.avatar == "circle"){ %>
                    <span style="flex:3;background-color:initial;">方形</span>
                    <span style="flex:7;background-color:rgba(30,200,30,.7);">圆形</span>
                    <% }else{ %>
                    <span style="flex:7;background-color:rgba(30,200,30,.7);">方形</span>
                    <span style="flex:3;background-color:initial;">圆形</span>
                    <% } %>
                    </p>
                    <p id="setting-bgtext" data-setting-bgtext="<%= UI.bgtext %>">背景文字:
                    <% if(UI.bgtext == "0"){ %>
                    <span style="flex:3;background-color:initial;">开启</span><span style="flex:7;background-color:rgba(30,200,30,.7);">关闭</span>
                    <p id="bgtext-input" style="display:none;"><i>This Will Show On the Background</i><input placeholder="logo text" value="<%= UI.bgtextContent %>"><i class="fa fa-check"></i></p>                    
                    </p>
                    <% }else{ %>
                    <span style="flex:7;background-color:rgba(30,200,30,.7)">开启</span><span style="flex:3;background-color:initial;">关闭</span>
                    </p>
                    <p id="bgtext-input"><i>This Will Show On the Background</i><input placeholder="logo text" value="<%= UI.bgtextContent %>"><i class="fa fa-check"></i></p>
                    <% } %>
                </div>
                <div id="background-setting" data-background-setting="<%= UI.background %>">
                    <div id="starfield">
                        <img src="/static/image/background/starfield.png">
                        <span>星空·夜(默认)</span>
                    </div>
                    <div id="starsky">
                        <img src="/static/image/background/starsky.png">
                        <span>星空·黄昏</span>
                    </div>
                    <div id="cloudsky">
                        <img src="/static/image/background/cloudsky.png">
                        <span>天空·渐变</span>
                    </div>
                    <div id="romanticbubble">
                        <img src="/static/image/background/romanticbubble.png">
                        <span>浪漫气泡</span>
                    </div>
                    <div id="mid-autumn">
                        <img src="/static/image/background/mid-autumn.png">
                        <span>节日·中秋</span>
                    </div>
                </div>
                <div id="settings-save">
                    <span>SAVE</span>
                </div>
            </div>
            <div id="c-r-s">
                <div id="c-r-s-wrap">
                    <div id="c-r-s-guests">
                        <i class="fa fa-user-circle-o"></i>
                        <span>来宾</span>
                    </div>
                    <div id="c-r-s-vote">
                        <i class="fa fa-bar-chart"></i>
                        <span>投票</span>
                    </div>
                    <div id="c-r-s-lottery">
                        <i class="fa fa-gift"></i>
                        <span>彩蛋</span>
                    </div>
                    <div id="c-r-s-host">
                        <i class="fa fa-user-circle-o"></i>
                        <span>主持</span>
                    </div>
                    <div id="c-r-s-sign" style="background:rgb(248, 104, 104);">
                        <i class="fa fa-bar-chart"></i>
                        <span>签到</span>
                    </div>
                    <div id="c-r-s-video" style="background:rgb(248, 104, 104);">
                        <i class="fa fa-gift"></i>
                        <span>直播</span>
                    </div>
                </div>
                <div id="c-r-s-panel-guests" class="c-r-s-panel">
                    <header><i class="fa fa-toggle-off" id="guests-flag"></i>来宾设置</header>
                    <div id="c-r-s-panel-guests-list" class="c-r-s-panel-guests-active">
                        <div id="c-r-s-panel-guests-addbtn">
                            <img src="/static/image/add_icon.ico" title="添加">
                        </div>
                    </div>
                    <div id="c-r-s-panel-guests-addnew">
                        <p><span class="loadingBar"><i></i></span><img src="/static/image/avatar_default.jpg" id="c-r-s-panel-guests-addnew-avatar" title="更换头像"></p>
                        <p><span>名称:</span><input name="guestName" id="c-r-s-panel-guests-addnew-guestName"></p>
                        <p><span>头衔:</span><input name="guestTitle" id="c-r-s-panel-guests-addnew-guestTitle"></p>
                        <p><span>介绍:</span><textarea name="guestIntroduction" rows="5" id="c-r-s-panel-guests-addnew-guestIntroduction"></textarea></p>
                        <p>
                            <span id="c-r-s-panel-guests-panel-save" style="color: #eeeeee;border-radius: 1em;background: #31b0d5;padding: 2px 5px;display: block;cursor:pointer;">保存</span>
                            <span id="c-r-s-panel-guests-panel-back" style="color: #eeeeee;border-radius: 1em;background: #31b0d5;padding: 2px 5px;display: block;margin-left: 5px;cursor:pointer;">返回</span>
                        </p>
                    </div>
                </div>
                <div id="c-r-s-panel-vote" class="c-r-s-panel">
                    <header><i class="fa fa-toggle-off" id="vote-flag"></i>投票设置</header>
                    <div id="c-r-s-panel-vote-list">
                        <div id="c-r-s-panel-vote-addbtn">
                            <img src="/static/image/add_icon.ico" title="添加">
                        </div>
                    </div>
                </div>
                <div id="c-r-s-panel-lottery" class="c-r-s-panel">
                    <header><i class="fa fa-toggle-off" id="lottery-flag"></i>彩蛋设置</header>
                    <div>

                    </div>
                </div>
                <div id="c-r-s-panel-host" class="c-r-s-panel">
                    <header><i class="fa fa-toggle-on" style="cursor:not-allowed"></i>主持控制台</header>
                    <div id="c-r-s-panel-host-panel">
                        <p id="host-alert"></p>
                        <p id="c-r-s-panel-host-input-number"><span>循环通知次数:</span><input type="number" min="1" max="10" step="1" value="2"></p>
                        <p id="c-r-s-panel-host-input"><i>Click or Hit Enter to Submit</i><input placeholder="Broadcast"><i class="fa fa-check"></i></p>
                    </div>
                </div>
                <div id="c-r-s-panel-sign" class="c-r-s-panel" style="background:rgb(248, 104, 104)"></div>
                <div id="c-r-s-panel-video" class="c-r-s-panel" style="background:rgb(248, 104, 104)"></div>
            </div>
            <div id="c-r-d">
                <div id="c-r-d-message">
                    <header>0</header>
                </div>
                <div id="c-r-d-shield"></div>
                <div id="c-r-d-show-panel" style="display: none;"></div>
                <div id="c-r-d-show-info">
            </div>
            <div id="c-r-c">

            </div>
        </div>
    </div>
</div>
</body>
</html>